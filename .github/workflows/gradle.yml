name: Build atlas using Gradle
on: [push]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
      with:
        submodules: recursive
        fetch-depth: 0
    - uses: actions/setup-java@v2
      with:
        java-version: 17
        distribution: 'temurin'
    - name: Set up Graal
      run: |
        mkdir graalvm
        wget -qO- 'https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-21.3.0/graalvm-ce-java17-linux-amd64-21.3.0.tar.gz' | tar xzf - --strip-components=1 -C graalvm
        ./graalvm/bin/gu install native-image
        echo "${PWD}/graalvm/bin" >> $GITHUB_PATH
        echo "org.gradle.java.installations.paths=${PWD}/graalvm" >> gradle.properties
    - run: |
        sudo apt-get install -y -q build-essential libz-dev zlib1g-dev libz3-java z3
        sudo ldconfig -v
        ldconfig -p
        stat /usr/lib/x86_64-linux-gnu/jni/libz3java.so
        stat /usr/lib/x86_64-linux-gnu/libz3.so
        echo "LD_LIBRARY_PATH=/usr/lib/x86_64-linux-gnu:/usr/lib/x86_64-linux-gnu/jni" >> $GITHUB_ENV
    - run: java -XshowSettings:properties -version
    - uses: gradle/gradle-build-action@v2
      with:
        gradle-version: '7.3.3'
        arguments: '--stacktrace javaToolchains jacocoTestReport nativeCompile '
    - run: ./build/native/nativeCompile/atlas --help
