name: Build lac
on: [push]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
      with:
        submodules: recursive
        fetch-depth: 0
    - uses: actions/cache@preview
      with:
        path: ~/.gradle/caches
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle.kts') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
    - uses: cachix/install-nix-action@v11
      with:
        install_url: https://github.com/numtide/nix-flakes-installer/releases/download/nix-3.0pre20201007_5257a25/install
        nix_path: nixpkgs=channel:nixos-20.09
        extra_nix_config: |
          experimental-features = nix-command flakes
    #- uses: cachix/cachix-action@v6
    # with:
    #   name: lorenzleutgeb-public
    #   signingKey: '${{ secrets.CACHIX_SIGNING_KEY }}'
    - run: nix flake check
    - run: "eval \"$(nix print-dev-env)\""
    - name: Build
      run: gradle build -x test
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v1
    - name: Push Docker Image to Docker Hub
      uses: docker/build-push-action@v2
      with:
        push: true
        username: ${{ secrets.DOCKER_HUB_USERNAME }}
        password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
        tags: lorenzleutgeb/lac:${{ github.sha }}
    - name: Push Docker Image to GitHub Packages
      uses: docker/build-push-action@v2
      with:
        push: true
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        tags: lorenzleutgeb/lac/lac:${{ github.sha }}
        registry: docker.pkg.github.com
    - name: Package TACAS Artifact
      run: ./tacas.sh
    - uses: actions/upload-artifact@v2
      with:
        name: tacas
        path: build/distributions/tacas.zip
